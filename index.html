<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exposici√≥n Final LP2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; scroll-behavior: smooth; }
        
        /* SECCIONES */
        section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        /* 1. PORTADA */
        #portada { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; text-align: center; }
        
        /* 2. TEOR√çA */
        #teoria { background-color: #ffffff; }
        .feature-box { padding: 30px; border-radius: 15px; transition: transform 0.3s; height: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .feature-box:hover { transform: translateY(-10px); background: #f8f9fa; }
        
        /* 3. VISOR DE C√ìDIGO */
        #codigo { background-color: #1e1e1e; color: #d4d4d4; }
        .vscode-window {
            background-color: #252526;
            width: 100%;
            max-width: 950px;
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
            font-family: 'Fira Code', monospace;
            text-align: left;
        }
        .vscode-header {
            background-color: #333333;
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #1e1e1e;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .red { background-color: #ff5f56; } .yellow { background-color: #ffbd2e; } .green { background-color: #27c93f; }
        
        .nav-tabs .nav-link { color: #aaaaaa; border: none; background: transparent; font-size: 0.9rem; }
        .nav-tabs .nav-link.active { color: #ffffff; background-color: #1e1e1e; border-top: 2px solid #007acc; }
        
        .code-content { padding: 20px; color: #9cdcfe; font-size: 0.8rem; line-height: 1.5; max-height: 600px; overflow-y: auto; }
        
        /* Sintaxis Python */
        .kwd { color: #569cd6; } /* keywords */
        .str { color: #ce9178; } /* strings */
        .num { color: #b5cea8; } /* numbers */
        .com { color: #6a9955; } /* comments */
        .func { color: #dcdcaa; } /* functions */
        .cls { color: #4ec9b0; } /* classes */
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">üéì Proyecto Final LP2</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#portada">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#teoria">L√≥gica</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#codigo">C√≥digo Fuente</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section id="portada">
        <div>
            <h1>LIMA HOUSING ANALYTICS</h1>
            <p class="lead">Integraci√≥n de APIs y Open Data para la valoraci√≥n de inmuebles</p>
            <hr class="my-4" style="width: 50%; margin: auto; border-color: rgba(255,255,255,0.3);">
            <p>Mar√≠a Fernanda Ch√°vez Mendoza | 20240703</p>
            <p>Hilary Penelope Cruz Cruz | 20240704</p>
            <a href="#teoria" class="btn btn-outline-light mt-3 rounded-pill">Comenzar Exposici√≥n üëá</a>
        </div>
    </section>

    <section id="teoria">
        <div class="container text-center">
            <h2 class="mb-5 text-dark fw-bold">Nuestra F√≥rmula de Valoraci√≥n</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="feature-box">
                        <div class="display-4 mb-3">üõ°Ô∏è</div>
                        <h4>40% Seguridad</h4>
                        <p class="text-muted small">Exploramos los datos de la INEI y solo filtramos los de LIMA METROPOLITANA para saber los delitos.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-box">
                        <div class="display-4 mb-3">üí∞</div>
                        <h4>40% Precio</h4>
                        <p class="text-muted small">Evaluaci√≥n de costo-beneficio. Se asigna mayor puntaje a propiedades con menor precio por m¬≤ comparado con el mercado real.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-box">
                        <div class="display-4 mb-3">üé°</div>
                        <h4>20% Servicios</h4>
                        <p class="text-muted small">Escaneo geoespacial (500m) contando <b>Parques</b>, <b>Transporte</b> y <b>Restaurantes</b> para medir habitabilidad.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="codigo">
        <div class="container">
            <h2 class="text-center text-white mb-4">üíª Arquitectura del C√≥digo</h2>
            
            <div class="vscode-window mx-auto">
                <div class="vscode-header">
                    <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
                    <span class="ms-3 text-muted small">Visual Studio Code - Proyecto LP2</span>
                </div>
                
                <ul class="nav nav-tabs px-2 pt-2" id="codeTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="google-tab" data-bs-toggle="tab" data-bs-target="#google" type="button">üêç Google_places_api.py</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logic-tab" data-bs-toggle="tab" data-bs-target="#logic" type="button">üìÑ data_processor.py</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="app-tab" data-bs-toggle="tab" data-bs-target="#app" type="button">‚öôÔ∏è process_security.py</button>
                    </li>
                </ul>

                <div class="tab-content" id="codeTabContent">
                    
                    <div class="tab-pane fade show active" id="google" role="tabpanel">
                        <div class="code-content">
                            <pre>
<span class="kwd">import</span> googlemaps

<span class="com"># ---------------------------------------------------------</span>
<span class="com"># PARTE 1: CONFIGURACI√ìN</span>
<span class="com"># ---------------------------------------------------------</span>
<span class="com"># Colocamos nuestra API key</span>
API_KEY = <span class="str">'AIzaSyA9yU8036YYM6pXyYOPAHEsV-AUJKT2YYU'</span>
gmaps = googlemaps.Client(key=API_KEY)

<span class="com"># ---------------------------------------------------------</span>
<span class="com"># PARTE 2: LAS FUNCIONES </span>
<span class="com"># ---------------------------------------------------------</span>

<span class="kwd">def</span> <span class="func">obtener_coordenadas_de_nombre</span>(nombre_lugar):
    <span class="str">""" Convierte un nombre (ej. 'Plaza de Armas') en coordenadas. """</span>
    <span class="func">print</span>(<span class="str">f"üîé Buscando coordenadas para: '{nombre_lugar}'..."</span>)
    respuesta = gmaps.geocode(nombre_lugar)
    
    <span class="kwd">if</span> respuesta:
        ubicacion = respuesta[<span class="num">0</span>][<span class="str">'geometry'</span>][<span class="str">'location'</span>]
        direccion = respuesta[<span class="num">0</span>][<span class="str">'formatted_address'</span>]
        <span class="func">print</span>(<span class="str">f"üìç Direcci√≥n encontrada: {direccion}"</span>)
        <span class="kwd">return</span> ubicacion[<span class="str">'lat'</span>], ubicacion[<span class="str">'lng'</span>]
    <span class="kwd">else</span>:
        <span class="func">print</span>(<span class="str">"‚ùå No se encontr√≥ el lugar."</span>)
        <span class="kwd">return</span> <span class="kwd">None</span>, <span class="kwd">None</span>

<span class="kwd">def</span> <span class="func">calcular_nota_servicios</span>(parques, transporte, restaurantes):

    <span class="com"># 1. TRANSPORTE (Max 4 puntos) </span>
    <span class="kwd">if</span> transporte >= <span class="num">8</span>:
        nota_transporte = <span class="num">4.0</span>
    <span class="kwd">else</span>:
        nota_transporte = transporte * <span class="num">0.5</span> 

    <span class="com"># 2. PARQUES (Max 3 puntos) </span>
    <span class="kwd">if</span> parques > <span class="num">3</span>: 
        nota_parques = <span class="num">3.0</span>
    <span class="kwd">else</span>:
        nota_parques = parques * <span class="num">0.75</span> 
        
    <span class="com"># 3. RESTAURANTES (Max 3 puntos) </span>
    <span class="kwd">if</span> restaurantes >= <span class="num">5</span>:
        nota_restaurantes = <span class="num">3.0</span>
    <span class="kwd">else</span>:
        nota_restaurantes = restaurantes * <span class="num">0.6</span>

    <span class="kwd">return</span> nota_transporte + nota_parques + nota_restaurantes

<span class="com"># Solo la nota de comisar√≠a</span>
<span class="kwd">def</span> <span class="func">calcular_nota_seguridad</span>(policia):
 <span class="com"># 1. COMISAR√çA (Max 3 puntos)</span>
    <span class="kwd">if</span> policia >= <span class="num">1</span>:
        <span class="kwd">return</span> <span class="num">10.0</span>
    <span class="kwd">else</span>:
        <span class="kwd">return</span> <span class="num">0.0</span>

<span class="kwd">def</span> <span class="func">analizar_zona_google</span>(lat, lon):

    <span class="func">print</span>(<span class="str">"üìä Analizando el entorno (500m a la redonda)..."</span>)
    
    <span class="com"># --- A. OBTENCI√ìN DE DATOS (API) ---</span>
    
    <span class="com"># 1. Restaurantes</span>
    res_restaurantes = gmaps.places_nearby(location=(lat, lon), radius=<span class="num">500</span>, type=<span class="str">'restaurant'</span>)
    num_restaurantes = <span class="func">len</span>(res_restaurantes.get(<span class="str">'results'</span>, []))

    <span class="com"># 2. Parques</span>
    res_parques = gmaps.places_nearby(location=(lat, lon), radius=<span class="num">500</span>, type=<span class="str">'park'</span>)
    num_parques = <span class="func">len</span>(res_parques.get(<span class="str">'results'</span>, []))
    
    <span class="com"># 3. Polic√≠a (Seguridad) - Radio 1km</span>
    res_policia = gmaps.places_nearby(location=(lat, lon), radius=<span class="num">1000</span>, type=<span class="str">'police'</span>)
    num_policia = <span class="func">len</span>(res_policia.get(<span class="str">'results'</span>, []))

    <span class="com"># 4. Transporte</span>
    res_transporte = gmaps.places_nearby(location=(lat, lon), radius=<span class="num">500</span>, type=<span class="str">'transit_station'</span>)
    num_transporte = <span class="func">len</span>(res_transporte.get(<span class="str">'results'</span>, []))

    <span class="com"># --- B. C√ÅLCULO DE NOTA  ---</span>
    
    puntaje_calculado = (<span class="func">calcular_nota_servicios</span>(num_parques, num_transporte, num_restaurantes)*<span class="num">0.2</span>)
    puntaje_policia = (<span class="func">calcular_nota_seguridad</span>(num_policia)*<span class="num">0.08</span>)

    <span class="com"># --- C. RESULTADO FINAL SERVICIOS (20%) ---</span>
    <span class="kwd">return</span> {
        <span class="str">"cantidades"</span>: {
            <span class="str">"restaurantes"</span>: num_restaurantes,
            <span class="str">"parques"</span>: num_parques,
            <span class="str">"policia"</span>: num_policia,
            <span class="str">"transporte"</span>: num_transporte
        },
        <span class="str">"puntaje_total"</span>: <span class="func">round</span>(puntaje_calculado, <span class="num">2</span>),
        <span class="com"># --- C.2 RESULTADO FINAL COMISAR√çAS (8%) ---</span>
        <span class="str">"puntaje_total_policia"</span>: <span class="func">round</span>(puntaje_policia, <span class="num">2</span>)
    }

<span class="com"># ---------------------------------------------------------</span>
<span class="com"># PARTE 3: EJECUCI√ìN</span>
<span class="com"># ---------------------------------------------------------</span>

<span class="com"># 1. Se escribe aqu√≠ el lugar que queremos probar</span>
mi_lugar = <span class="str">"Ceres, Ate"</span> 

<span class="com"># 2. Obtenemos coordenadas</span>
lat, lon = <span class="func">obtener_coordenadas_de_nombre</span>(mi_lugar)

<span class="com"># 3. Se analizan las coordenadas</span>
<span class="kwd">if</span> lat <span class="kwd">and</span> lon:
    resultados = <span class="func">analizar_zona_google</span>(lat, lon)
    
    <span class="func">print</span>(<span class="str">"\n"</span> + <span class="str">"="</span>*<span class="num">60</span>)
    <span class="func">print</span>(<span class="str">f"   AN√ÅLISIS DE SERVICIOS (20% del total): {mi_lugar}"</span>)
    <span class="func">print</span>(<span class="str">"="</span>*<span class="num">60</span>)
    <span class="func">print</span>(<span class="str">f"üöå Transporte:    {resultados['cantidades']['transporte']}"</span>)
    <span class="func">print</span>(<span class="str">f"üå≥ Parques:       {resultados['cantidades']['parques']}"</span>)
    <span class="func">print</span>(<span class="str">f"üçΩÔ∏è Restaurantes:  {resultados['cantidades']['restaurantes']}"</span>)
    <span class="func">print</span>(<span class="str">"-"</span> * <span class="num">60</span>)
    <span class="func">print</span>(<span class="str">f"‚≠ê NOTA FINAL:    {resultados['puntaje_total']}"</span>)
    <span class="func">print</span>(<span class="str">"="</span>*<span class="num">60</span>)

    <span class="func">print</span>(<span class="str">"="</span>*<span class="num">60</span>)
    <span class="func">print</span>(<span class="str">"--- üõ°Ô∏è BLOQUE SEGURIDAD ( 8% del total del 40% de SEGURIDAD) ---"</span>)
    <span class="func">print</span>(<span class="str">f"üëÆ Comisar√≠as:    {resultados['cantidades']['policia']} encontradas (1km)"</span>)
    <span class="func">print</span>(<span class="str">"-"</span> * <span class="num">60</span>)
    <span class="func">print</span>(<span class="str">f"üëâ NOTA INFRAESTRUCTURA POLICIAL: {resultados['puntaje_total_policia']}"</span>)
    <span class="func">print</span>(<span class="str">"="</span>*<span class="num">60</span>)
                            </pre>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="logic" role="tabpanel">
                        <div class="code-content">
                            <pre>
<span class="kwd">import</span> pandas <span class="kwd">as</span> pd
<span class="kwd">import</span> os
<span class="kwd">import</span> re

<span class="kwd">def</span> <span class="func">clean_price</span>(price_str):
    <span class="str">"""Limpia y convierte precios a soles"""</span>
    <span class="kwd">if</span> pd.isna(price_str):
        <span class="kwd">return</span> <span class="kwd">None</span>
    
    price_str = <span class="func">str</span>(price_str).upper().strip()
    
    <span class="com"># Extraer n√∫mero (soporta comas como separadores de miles)</span>
    number_match = re.search(<span class="str">r'[\d,]+\.?\d*'</span>, price_str.replace(<span class="str">','</span>, <span class="str">''</span>))
    <span class="kwd">if</span> <span class="kwd">not</span> number_match:
        <span class="kwd">return</span> <span class="kwd">None</span>
    
    value = <span class="func">float</span>(number_match.group(<span class="num">0</span>).replace(<span class="str">','</span>, <span class="str">''</span>))
    
    <span class="com"># Detectar moneda</span>
    <span class="kwd">if</span> <span class="str">'USD'</span> <span class="kwd">in</span> price_str:
        <span class="kwd">return</span> value * <span class="num">3.7</span>  <span class="com"># tipo de cambio</span>
    <span class="kwd">else</span>:
        <span class="kwd">return</span> value  <span class="com"># asumir soles</span>

<span class="kwd">def</span> <span class="func">clean_area</span>(area_str):
    <span class="str">"""Limpia el √°rea y extrae el valor num√©rico"""</span>
    <span class="kwd">if</span> pd.isna(area_str):
        <span class="kwd">return</span> <span class="kwd">None</span>
    
    <span class="com"># Buscar n√∫mero (puede tener comas)</span>
    match = re.search(<span class="str">r'[\d,]+\.?\d*'</span>, <span class="func">str</span>(area_str).replace(<span class="str">','</span>, <span class="str">''</span>))
    <span class="kwd">return</span> <span class="func">float</span>(match.group(<span class="num">0</span>)) <span class="kwd">if</span> match <span class="kwd">else</span> <span class="kwd">None</span>

<span class="kwd">def</span> <span class="func">clean_bedroom_bathroom</span>(value):
    <span class="str">"""Convierte '2 dormitorios' o '3 ba√±os' a int"""</span>
    <span class="kwd">if</span> pd.isna(value):
        <span class="kwd">return</span> <span class="num">1</span>
    
    value_str = <span class="func">str</span>(value).strip()
    match = re.search(<span class="str">r'(\d+)'</span>, value_str)
    <span class="kwd">return</span> <span class="func">int</span>(match.group(<span class="num">1</span>)) <span class="kwd">if</span> match <span class="kwd">else</span> <span class="num">1</span>

<span class="kwd">def</span> <span class="func">extract_district_from_location</span>(location):
    <span class="str">"""
    Extrae el distrito de una ubicaci√≥n.
    Para Lima: 'Ur. Santa Cruz, Miraflores, Lima, Lima' ‚Üí 'MIRAFLORES'
    """</span>
    <span class="kwd">if</span> pd.isna(location):
        <span class="kwd">return</span> <span class="kwd">None</span>
    
    loc = <span class="func">str</span>(location).strip().upper()
    
    <span class="com"># Patr√≥n espec√≠fico para Lima: algo, DISTRITO, Lima, Lima</span>
    pattern = <span class="str">r',\s*([A-Z√ë√Å√â√ç√ì√ö\s\-]+),\s*LIMA,\s*LIMA\s*$'</span>
    match = re.search(pattern, loc)
    
    <span class="kwd">if</span> match:
        district = match.group(<span class="num">1</span>).strip()
        
        <span class="com"># Limpiar prefijos comunes</span>
        district = re.sub(<span class="str">r'^(URB\.|URB|UR\.|UR|AV\.|AV|CALLE|JR\.|JR)\s+'</span>, <span class="str">''</span>, district)
        
        <span class="com"># Corregir nombres espec√≠ficos</span>
        corrections = {
            <span class="str">'SANTIAGO DE SURCO'</span>: <span class="str">'SURCO'</span>,
            <span class="str">'SAN MART√çN DE PORRES'</span>: <span class="str">'SAN MARTIN DE PORRES'</span>,
            <span class="str">'JES√öS MAR√çA'</span>: <span class="str">'JESUS MARIA'</span>,
            <span class="str">'MAGDALENA DEL MAR'</span>: <span class="str">'MAGDALENA DEL MAR'</span>,
            <span class="str">'VILLA MAR√çA DEL TRIUNFO'</span>: <span class="str">'VILLA MARIA DEL TRIUNFO'</span>,
            <span class="str">'LURIGANCHO - CHOSICA'</span>: <span class="str">'LURIGANCHO'</span>,
            <span class="str">'SANTA MAR√çA DEL MAR'</span>: <span class="str">'SANTA MARIA DEL MAR'</span>
        }
        
        <span class="kwd">for</span> wrong, correct <span class="kwd">in</span> corrections.items():
            <span class="kwd">if</span> wrong <span class="kwd">in</span> district:
                district = district.replace(wrong, correct)
                <span class="kwd">break</span>
        
        <span class="kwd">return</span> district
    
    <span class="kwd">return</span> <span class="kwd">None</span>

<span class="kwd">def</span> <span class="func">normalize_district_name</span>(district):
    <span class="str">"""Normaliza nombres de distritos para coincidir con CSV"""</span>
    <span class="kwd">if</span> pd.isna(district):
        <span class="kwd">return</span> <span class="kwd">None</span>
    
    district_str = <span class="func">str</span>(district).upper().strip()
    
    <span class="com"># Lista exacta de distritos</span>
    VALID_DISTRICTS = [
        <span class="str">'ANCON'</span>, <span class="str">'ATE'</span>, <span class="str">'BARRANCO'</span>, <span class="str">'BRE√ëA'</span>, <span class="str">'CARABAYLLO'</span>, <span class="str">'CHACLACAYO'</span>,
        <span class="str">'CHORRILLOS'</span>, <span class="str">'CIENEGUILLA'</span>, <span class="str">'COMAS'</span>, <span class="str">'EL AGUSTINO'</span>, <span class="str">'INDEPENDENCIA'</span>,
        <span class="str">'JESUS MARIA'</span>, <span class="str">'LA MOLINA'</span>, <span class="str">'LA VICTORIA'</span>, <span class="str">'LIMA'</span>, <span class="str">'LINCE'</span>, <span class="str">'LOS OLIVOS'</span>,
        <span class="str">'LURIGANCHO'</span>, <span class="str">'LURIN'</span>, <span class="str">'MAGDALENA DEL MAR'</span>, <span class="str">'MIRAFLORES'</span>, <span class="str">'PACHACAMAC'</span>,
        <span class="str">'PUEBLO LIBRE'</span>, <span class="str">'PUENTE PIEDRA'</span>, <span class="str">'RIMAC'</span>, <span class="str">'SAN BARTOLO'</span>, <span class="str">'SAN BORJA'</span>,
        <span class="str">'SAN ISIDRO'</span>, <span class="str">'SAN JUAN DE LURIGANCHO'</span>, <span class="str">'SAN JUAN DE MIRAFLORES'</span>,
        <span class="str">'SAN LUIS'</span>, <span class="str">'SAN MARTIN DE PORRES'</span>, <span class="str">'SAN MIGUEL'</span>, <span class="str">'SANTA ANITA'</span>,
        <span class="str">'SANTA MARIA DEL MAR'</span>, <span class="str">'SANTA ROSA'</span>, <span class="str">'SURCO'</span>, <span class="str">'SURQUILLO'</span>,
        <span class="str">'VILLA EL SALVADOR'</span>, <span class="str">'VILLA MARIA DEL TRIUNFO'</span>, <span class="str">'PUNTA HERMOSA'</span>,
        <span class="str">'PUNTA NEGRA'</span>, <span class="str">'PUCUSANA'</span>
    ]
    
    <span class="kwd">if</span> district_str <span class="kwd">in</span> VALID_DISTRICTS:
        <span class="kwd">return</span> district_str
    
    mappings = {
        <span class="str">'SANTIAGO DE SURCO'</span>: <span class="str">'SURCO'</span>,
        <span class="str">'LURIGANCHO - CHOSICA'</span>: <span class="str">'LURIGANCHO'</span>,
        <span class="str">'SAN MART√çN DE PORRES'</span>: <span class="str">'SAN MARTIN DE PORRES'</span>,
        <span class="str">'JES√öS MAR√çA'</span>: <span class="str">'JESUS MARIA'</span>,
        <span class="str">'VILLA MAR√çA DEL TRIUNFO'</span>: <span class="str">'VILLA MARIA DEL TRIUNFO'</span>,
        <span class="str">'SANTA MAR√çA DEL MAR'</span>: <span class="str">'SANTA MARIA DEL MAR'</span>
    }
    
    <span class="kwd">for</span> wrong, correct <span class="kwd">in</span> mappings.items():
        <span class="kwd">if</span> wrong <span class="kwd">in</span> district_str:
            <span class="kwd">return</span> correct
    
    <span class="kwd">return</span> <span class="kwd">None</span>

<span class="kwd">def</span> <span class="func">calculate_scores</span>(df):
    <span class="str">"""Calcula scores para propiedades de Lima"""</span>
    
    <span class="func">print</span>(<span class="str">"üßπ Limpiando datos b√°sicos..."</span>)
    
    <span class="com"># Limpiar datos b√°sicos</span>
    df[<span class="str">'price_clean'</span>] = df[<span class="str">'price'</span>].apply(clean_price)
    df[<span class="str">'area_clean'</span>] = df[<span class="str">'area'</span>].apply(clean_area)
    df[<span class="str">'bedroom_clean'</span>] = df[<span class="str">'bedroom'</span>].apply(clean_bedroom_bathroom)
    df[<span class="str">'bathroom_clean'</span>] = df[<span class="str">'bathroom'</span>].apply(clean_bedroom_bathroom)
    
    <span class="com"># A√±o de construcci√≥n</span>
    <span class="kwd">if</span> <span class="str">'year_contruction'</span> <span class="kwd">in</span> df.columns:
        df[<span class="str">'year_contruction'</span>] = pd.to_numeric(df[<span class="str">'year_contruction'</span>], errors=<span class="str">'coerce'</span>)
    df[<span class="str">'year_contruction'</span>] = df[<span class="str">'year_contruction'</span>].fillna(<span class="num">2000</span>)
    
    <span class="func">print</span>(<span class="str">"üìç Extrayendo distritos..."</span>)
    
    df[<span class="str">'district'</span>] = df[<span class="str">'location'</span>].apply(extract_district_from_location)
    
    <span class="com"># Filtrar SOLO propiedades con distrito v√°lido de Lima</span>
    initial_count = <span class="func">len</span>(df)
    df = df[df[<span class="str">'district'</span>].notna()].copy()
    <span class="func">print</span>(<span class="str">f"   Propiedades con distrito de Lima: {len(df)}/{initial_count}"</span>)
    
    df[<span class="str">'district'</span>] = df[<span class="str">'district'</span>].apply(normalize_district_name)
    
    <span class="com"># Cargar datos de seguridad y Merge</span>
    security_df = pd.read_csv(<span class="str">"data/processed/security_by_district.csv"</span>)
    security_df[<span class="str">"district_norm"</span>] = security_df[<span class="str">"district"</span>].apply(normalize_district_name)
    
    df = pd.merge(
        df,
        security_df[[<span class="str">"district_norm"</span>, <span class="str">"security_score"</span>]].rename(columns={<span class="str">"district_norm"</span>: <span class="str">"district"</span>}),
        on=<span class="str">"district"</span>,
        how=<span class="str">"left"</span>
    )
    
    df[<span class="str">"safety_score"</span>] = df[<span class="str">"security_score"</span>].fillna(<span class="num">5.0</span>)
    
    <span class="func">print</span>(<span class="str">"üí∞ Calculando cost_score..."</span>)
    
    <span class="com"># COST_SCORE: precio por m¬≤ normalizado</span>
    df[<span class="str">'cost_score'</span>] = <span class="num">5.0</span>
    valid_mask = df[<span class="str">'price_clean'</span>].notna() & df[<span class="str">'area_clean'</span>].notna() & (df[<span class="str">'area_clean'</span>] > <span class="num">0</span>)
    valid_data = df[valid_mask].copy()
    
    <span class="kwd">if</span> <span class="func">len</span>(valid_data) > <span class="num">0</span>:
        valid_data[<span class="str">'price_per_m2'</span>] = valid_data[<span class="str">'price_clean'</span>] / valid_data[<span class="str">'area_clean'</span>]
        max_price_m2 = valid_data[<span class="str">'price_per_m2'</span>].max()
        
        <span class="kwd">if</span> max_price_m2 > <span class="num">0</span>:
            valid_data[<span class="str">'cost_score'</span>] = <span class="num">10</span> * (<span class="num">1</span> - valid_data[<span class="str">'price_per_m2'</span>] / max_price_m2)
            valid_data[<span class="str">'cost_score'</span>] = valid_data[<span class="str">'cost_score'</span>].clip(<span class="num">0</span>, <span class="num">10</span>)
        
        df.loc[valid_data.index, <span class="str">'cost_score'</span>] = valid_data[<span class="str">'cost_score'</span>]
    
    <span class="func">print</span>(<span class="str">"üõãÔ∏è Calculando services_score..."</span>)
    
    size_score = (df[<span class="str">'bedroom_clean'</span>] + df[<span class="str">'bathroom_clean'</span>]) * <span class="num">1.5</span>
    size_score = size_score.clip(<span class="num">0</span>, <span class="num">10</span>)
    
    age = <span class="num">2024</span> - df[<span class="str">'year_contruction'</span>]
    age_score = <span class="num">10</span> * (<span class="num">1</span> - age / <span class="num">100</span>)
    age_score = age_score.clip(<span class="num">0</span>, <span class="num">10</span>)
    
    df[<span class="str">'services_score'</span>] = (size_score * <span class="num">0.6</span> + age_score * <span class="num">0.4</span>).clip(<span class="num">0</span>, <span class="num">10</span>)
    
    <span class="func">print</span>(<span class="str">"üéØ Calculando score final..."</span>)
    
    df[<span class="str">'final_score'</span>] = (
        df[<span class="str">'cost_score'</span>] * <span class="num">0.4</span> + 
        df[<span class="str">'safety_score'</span>] * <span class="num">0.4</span> + 
        df[<span class="str">'services_score'</span>] * <span class="num">0.2</span>
    ).round(<span class="num">2</span>)
    
    df = df.sort_values(<span class="str">'final_score'</span>, ascending=<span class="kwd">False</span>)
    
    valid_for_display = df[
        df[<span class="str">'price_clean'</span>].notna() & 
        df[<span class="str">'area_clean'</span>].notna() & 
        (df[<span class="str">'area_clean'</span>] > <span class="num">0</span>)
    ].copy()
    
    <span class="kwd">return</span> df, valid_for_display

<span class="kwd">def</span> <span class="func">main</span>():
    <span class="func">print</span>(<span class="str">"="</span>*<span class="num">60</span>)
    <span class="func">print</span>(<span class="str">"üè° LIMA HOUSING ANALYTICS - PROCESADOR FINAL"</span>)
    <span class="func">print</span>(<span class="str">"="</span>*<span class="num">60</span>)
    
    <span class="kwd">try</span>:
        <span class="func">print</span>(<span class="str">"\nüì• Cargando dataset..."</span>)
        df = pd.read_csv(<span class="str">'data/raw/dataset.csv'</span>, encoding=<span class="str">'utf-8'</span>)
        
        <span class="kwd">if</span> <span class="str">'operation_type'</span> <span class="kwd">in</span> df.columns:
            df = df[df[<span class="str">'operation_type'</span>].str.contains(<span class="str">'alquiler'</span>, case=<span class="kwd">False</span>, na=<span class="kwd">False</span>)]
        
        df_scored, valid_data = <span class="func">calculate_scores</span>(df)
        
        <span class="func">print</span>(<span class="str">f"\nüìä RESULTADOS: {len(df_scored)} procesados"</span>)
        
        output_csv = <span class="str">'data/processed/scored_properties.csv'</span>
        os.makedirs(os.path.dirname(output_csv), exist_ok=<span class="kwd">True</span>)
        df_scored.to_csv(output_csv, index=<span class="kwd">False</span>, encoding=<span class="str">'utf-8-sig'</span>)
        
        <span class="com"># Preparar JSON para frontend (Simplificado para vista)</span>
        <span class="func">print</span>(<span class="str">"\nüîÑ Generando JSON..."</span>)
        <span class="func">print</span>(<span class="str">"\nüéâ PROCESAMIENTO COMPLETADO!"</span>)
        
    <span class="kwd">except</span> <span class="cls">Exception</span> <span class="kwd">as</span> e:
        <span class="func">print</span>(<span class="str">f"\n‚ùå ERROR: {e}"</span>)

<span class="kwd">if</span> __name__ == <span class="str">"__main__"</span>:
    <span class="func">main</span>()
                            </pre>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="app" role="tabpanel">
                        <div class="code-content">
                            <pre>
<span class="kwd">import</span> pandas <span class="kwd">as</span> pd

<span class="com"># 1. Cargar CSV INEI</span>
df = pd.read_csv(<span class="str">"data/raw/security_raw.csv"</span>, encoding=<span class="str">"latin1"</span>)

<span class="com"># 2. Filtrar SOLO Lima Metropolitana</span>
df = df[df[<span class="str">"DPTO_HECHO_NEW"</span>].str.strip() == <span class="str">"LIMA METROPOLITANA"</span>]

<span class="com"># 3. Filtrar SOLO provincia Lima</span>
df = df[df[<span class="str">"PROV_HECHO"</span>].str.strip() == <span class="str">"LIMA"</span>]

<span class="com"># 4. Limpiar distrito</span>
df[<span class="str">"district"</span>] = (
    df[<span class="str">"DIST_HECHO"</span>]
    .astype(<span class="func">str</span>)
    .str.upper()
    .str.strip()
)

<span class="com"># 5. Agrupar delitos por distrito</span>
security = (
    df.groupby(<span class="str">"district"</span>)[<span class="str">"cantidad"</span>]
    .sum()
    .reset_index()
)

security.rename(columns={<span class="str">"cantidad"</span>: <span class="str">"crime_count"</span>}, inplace=<span class="kwd">True</span>)


<span class="com"># Normalizar nombres de distrito (encoding + formato)</span>
security[<span class="str">"district"</span>] = (
    security[<span class="str">"district"</span>]
    .str.upper()
    .str.replace(<span class="str">"√É‚Äò"</span>, <span class="str">"√ë"</span>)
    .str.strip()
)


max_crime = security[<span class="str">"crime_count"</span>].max()
min_crime = security[<span class="str">"crime_count"</span>].min()

security[<span class="str">"security_score"</span>] = (
    <span class="num">10</span> - (
        (security[<span class="str">"crime_count"</span>] - min_crime) /
        (max_crime - min_crime) * <span class="num">10</span>
    )
).round(<span class="num">2</span>)


<span class="com"># 6. Guardar resultado</span>
security.to_csv(
    <span class="str">"data/processed/security_by_district.csv"</span>,
    index=<span class="kwd">False</span>,
    encoding=<span class="str">"utf-8-sig"</span>
)

<span class="func">print</span>(<span class="str">"‚úÖ Seguridad INEI procesada correctamente"</span>)
<span class="func">print</span>(<span class="str">"üìä Distritos √∫nicos:"</span>, security.shape[<span class="num">0</span>])
<span class="func">print</span>(security.sort_values(<span class="str">"crime_count"</span>, ascending=<span class="kwd">False</span>).head())
                            </pre>
                        </div>
                    </div>

                </div>
            </div>
            <p class="text-center text-muted mt-3 small">M√≥dulos principales del sistema.</p>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
