import requests
from bs4 import BeautifulSoup
import pandas as pd
import time
import re

# Headers para simular navegador
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Accept-Language': 'es-ES,es;q=0.9',
}

def scrape_inmuebles24(url):
    """Ejemplo para Inmuebles24 o similar"""
    try:
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.content, 'html.parser')
        propiedades = []
        
        # Selectores - DEBES AJUSTARLOS según la página específica
        # Estos son ejemplos genéricos
        lista_propiedades = soup.find_all('div', class_=re.compile(r'posting|property|item'))
        
        for prop in lista_propiedades[:10]:  # Limitar a 10 para prueba
            try:
                # Extraer datos (ajusta selectores)
                titulo = prop.find('h2', class_=re.compile(r'title|name'))
                precio = prop.find('span', class_=re.compile(r'price|valor'))
                direccion = prop.find('div', class_=re.compile(r'location|address'))
                detalles = prop.find('ul', class_=re.compile(r'features|details'))
                
                propiedad_data = {
                    'titulo': titulo.text.strip() if titulo else 'No disponible',
                    'precio': precio.text.strip() if precio else 'Consultar',
                    'direccion': direccion.text.strip() if direccion else 'No disponible',
                    'habitaciones': extraer_detalle(detalles, 'habitacion|dorm'),
                    'banos': extraer_detalle(detalles, 'bano|banio'),
                    'metros': extraer_detalle(detalles, 'metro|area|m²'),
                    'enlace': obtener_enlace(prop),
                    'portal': 'Inmuebles24'
                }
                propiedades.append(propiedad_data)
                
            except Exception as e:
                print(f"Error procesando propiedad: {e}")
                continue
        
        return propiedades
        
    except requests.RequestException as e:
        print(f"Error en la solicitud: {e}")
        return []

def extraer_detalle(elemento, patron):
    """Extrae detalles específicos usando regex"""
    if not elemento:
        return 'N/A'
    
    items = elemento.find_all('li')
    for item in items:
        if re.search(patron, item.text, re.IGNORECASE):
            return item.text.strip()
    return 'N/A'

def obtener_enlace(prop):
    """Extrae enlace a la propiedad"""
    link = prop.find('a', href=True)
    if link:
        href = link['href']
        if not href.startswith('http'):
            return 'https://www.inmuebles24.com' + href
        return href
    return ''

def scrape_urbania(url):
    """Ejemplo para Urbania"""
    propiedades = []
    # Implementar lógica similar con selectores de Urbania
    return propiedades

def main():
    # URLs de ejemplo - REEMPLAZA con las reales
    urls = {
        'Inmuebles24': 'https://www.inmuebles24.com/departamentos-alquiler-lima.html',
        'Urbania': 'https://urbania.pe/alquiler/departamentos/lima',
        'Adondevivir': 'https://www.adondevivir.com/departamentos-alquiler-lima.html'
    }
    
    todas_propiedades = []
    
    for portal, url in urls.items():
        print(f"Scrapeando {portal}...")
        
        if 'inmuebles24' in url.lower():
            props = scrape_inmuebles24(url)
        elif 'urbania' in url.lower():
            props = scrape_urbania(url)
        else:
            props = []
        
        todas_propiedades.extend(props)
        time.sleep(2)  # Respetar tiempos entre solicitudes
    
    # Crear DataFrame y exportar
    if todas_propiedades:
        df = pd.DataFrame(todas_propiedades)
        print(f"\nTotal propiedades encontradas: {len(df)}")
        print(df.head())
        
        # Exportar a CSV
        df.to_csv('alquileres_lima.csv', index=False, encoding='utf-8')
        print("Datos exportados a 'alquileres_lima.csv'")
    else:
        print("No se encontraron propiedades")

if __name__ == '__main__':
    main()